generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


model User {
  id          String    @id @default(uuid())
  clerkUserId String    @unique
  createdAt   DateTime  @default(now())

  projects    Project[]
  profile     WriterProfile?
  threads     AgentThread[]
}

model Project {
  id        String   @id @default(uuid())
  ownerId   String
  title     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner     User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  scripts   Script[]
  lookbookDrafts      LookbookDraft[]
  inspirationBoards   InspirationBoard[]
  visualBibles        VisualBible[]
  storyboardPromptSets StoryboardPromptSet[]
}

model Script {
  id        String   @id @default(uuid())
  projectId String
  title     String
  fountain  String   @db.Text
  updatedAt DateTime @updatedAt

  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  versions  ScriptVersion[]
  threads   AgentThread[]
}

model ScriptVersion {
  id        String   @id @default(uuid())
  scriptId  String
  fountain  String   @db.Text
  reason    String?
  createdAt DateTime @default(now())

  script    Script   @relation(fields: [scriptId], references: [id], onDelete: Cascade)
}

model WriterProfile {
  id          String   @id @default(uuid())
  userId      String   @unique
  tone        String   @default("neutral")
  focus       String   @default("balanced")
  avoidTheme  Boolean  @default(false)
  avoidSymbolism Boolean @default(false)
  notes       String   @db.Text @default("")
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AgentThread {
  id        String   @id @default(uuid())
  scriptId  String
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  script    Script   @relation(fields: [scriptId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  AgentMessage[]

  @@unique([scriptId, userId])
}

model AgentMessage {
  id        String   @id @default(uuid())
  threadId  String
  role      String
  content   String   @db.Text
  createdAt DateTime @default(now())

  thread    AgentThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId, createdAt])
}

model LookbookDraft {
  id                  String   @id @default(cuid())
  projectId           String
  scriptId            String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  logline             String?
  genreTags           String[]
  timePeriod          String?
  toneKeywords        String[]
  lensLanguage        String
  lightingMotifs      String[]
  palette             Json
  compositionRules    String[]
  cameraMovementRules String[]
  referencesSeed      Json

  knobs               Json?
  source              Json?

  project             Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  inspirationBoards   InspirationBoard[]
  visualBibles        VisualBible[]

  @@index([projectId])
}

model InspirationBoard {
  id         String   @id @default(cuid())
  projectId  String
  lookbookId String
  createdAt  DateTime @default(now())

  items      Json

  project    Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  lookbook   LookbookDraft @relation(fields: [lookbookId], references: [id], onDelete: Cascade)

  visualBibles VisualBible[]

  @@index([projectId])
  @@index([lookbookId])
}

model VisualBible {
  id                  String   @id @default(cuid())
  projectId           String
  lookbookId          String
  inspirationBoardId  String
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  onePageSummary      String
  doList              String[]
  dontList            String[]
  styleRules          Json
  shotDesignPrinciples String[]
  sceneOverrides      Json
  ruleSources         Json?

  project             Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  lookbook            LookbookDraft    @relation(fields: [lookbookId], references: [id], onDelete: Cascade)
  inspirationBoard    InspirationBoard @relation(fields: [inspirationBoardId], references: [id], onDelete: Cascade)

  storyboardPromptSets StoryboardPromptSet[]

  @@index([projectId])
}

model StoryboardPromptSet {
  id               String   @id @default(cuid())
  projectId        String
  visualBibleId    String
  sceneId          String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  continuityHeader String
  beats            Json
  cohesionWarnings String[]
  imageResultIds   String[]

  project          Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  visualBible      VisualBible @relation(fields: [visualBibleId], references: [id], onDelete: Cascade)

  @@unique([visualBibleId, sceneId])
  @@index([projectId])
  @@index([sceneId])
}
